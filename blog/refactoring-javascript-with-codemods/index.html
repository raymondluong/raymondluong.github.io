<!DOCTYPE html>
<html lang="en" data-theme="lofi">
  <head>
    <!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/svg+xml" href="/favicon.ico">
<meta name="generator" content="Astro v2.0.5">

<!-- Primary Meta Tags -->
<title>Refactoring JavaScript with Codemods</title>
<meta name="title" content="Refactoring JavaScript with Codemods">
<meta name="description" content="Codemods are handy for automating large-scale changes. In this article, I'll share more about codemods, walk through a simple codemod that I wrote, and share some tips for debugging.">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://www.raymondluong.com/blog/refactoring-javascript-with-codemods/">
<meta property="og:title" content="Refactoring JavaScript with Codemods">
<meta property="og:description" content="Codemods are handy for automating large-scale changes. In this article, I'll share more about codemods, walk through a simple codemod that I wrote, and share some tips for debugging.">
<meta property="og:image" content="https://www.raymondluong.com/social_img.png">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://www.raymondluong.com/blog/refactoring-javascript-with-codemods/">
<meta property="twitter:title" content="Refactoring JavaScript with Codemods">
<meta property="twitter:description" content="Codemods are handy for automating large-scale changes. In this article, I'll share more about codemods, walk through a simple codemod that I wrote, and share some tips for debugging.">
<meta property="twitter:image" content="https://www.raymondluong.com/social_img.png">
  <link rel="stylesheet" href="/_astro/about.18179f45.css" />
<link rel="stylesheet" href="/_astro/_slug_.d192f2f0.css" /></head>
  <body>
    <div class="bg-base-100 drawer drawer-mobile">
      <input id="my-drawer" type="checkbox" class="drawer-toggle">
      <div class="drawer-content flex flex-col bg-base-100">
        <div class="sticky lg:hidden top-0 z-30 flex h-16 w-full justify-center bg-opacity-90 backdrop-blur transition-all duration-100 bg-base-100 text-base-content shadow-sm">
  <div class="navbar">
    <div class="navbar-start">
      <label for="my-drawer" class="btn btn-square btn-ghost">
        <svg viewBox="0 0 24 24" class="w-8 h-8" astro-icon="ri:menu-4-line"><path fill="currentColor" d="M16 18v2H5v-2h11zm5-7v2H3v-2h18zm-2-7v2H8V4h11z"/></svg>
      </label>
    </div>
    <div class="navbar-center">
      <a class="btn btn-ghost normal-case text-xl" href="/">Raymond Luong</a>
    </div>
    <div class="navbar-end"></div>
  </div>
</div>
        <div class="md:flex md:justify-center">
          <main class="p-6 pt-10 max-w-[900px]">
            <main class="md:flex md:justify-center">
    <article class="prose max-w-[750px] prose-img:mx-auto">
      <h1 class="title my-2 text-3xl font-bold">Refactoring JavaScript with Codemods</h1>
      <time>Jul 4, 2019</time>
      <p>One of the most exciting parts about working with JavaScript is the fast-paced nature of the ecosystem. New patterns and standards evolve over time. However, keeping up with the changes can be complex and time-consuming because they may involve large-scale modifications or refactors that are a bit more involved than a simple find-and-replace.</p>
<p>Fortunately, codemods are a handy tool that help us automate these changes. In this article, Iâ€™ll share more about codemods, walk through a simple codemod that I wrote, and share some tips for debugging.</p>
<p>#What are codemods?
Codemods are scripts that automate a code change. Theyâ€™re usually comprised of two parts:</p>
<ol>
<li>Find all instances of the code to be changed, most easily accomplished with some form of pattern matching</li>
<li>Apply a transformation to each instance, usually based on the original instance but with some modifications</li>
</ol>
<p>#When can I use codemods?
I mentioned large-scale refactors earlier â€” these can happen when upgrading versions of packages where existing methods are deprecated or new methods are introduced. They can also be used for syntax improvements or linting fixes.</p>
<p>For example, in my current role at Gusto, weâ€™ve used codemods to fix ESLint errors (more on this below) and move off deprecated React features.</p>
<p>#How do I write one?
To demonstrate how to write a codemod, Iâ€™ll walk through an example I wrote to fix an ESLint error. I assume a basic understanding of JavaScript, React, and tree data structures. Iâ€™ll also talk about <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank">ASTs (Abstract Syntax Trees)</a> but prior knowledge is not a required.</p>
<p>##Context
At Gusto, we added ESLint to our codebase after we had already written a bunch of React components. However, some of our existing components did not match the ESLint rules that we decided to enforce. To avoid having those errors block us from adding ESLint, we suppressed the existing errors and added ESLint so it could immediately start having value for our new code going forward.</p>
<p>One of the errors we suppressed is <code>react/destructuring-assignment</code>, which prefers using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment" target="_blank">ES6 destructuring syntax</a> when possible. For example:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #FFA657">mailingAddress</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">address</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.props;</span></span></code></pre>
<p>is preferred to</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">address</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.props.mailingAddress;</span></span></code></pre>
<p>There are a bunch of components in our codebase that do not destructure and have the destructuring-assignment rule suppressed. Iâ€™ll walk through a codemod I wrote to address the specific case above. Note that this is just one example and it doesnâ€™t cover <em>all</em> the violations of the destructuring-assignment rule. When writing codemods, Iâ€™ve found that itâ€™s simplest to start with the basic cases and gradually add on more complex cases.</p>
<p>##Step 0: Boilerplate code
The <a href="https://github.com/facebook/jscodeshift" target="_blank">jscodeshift</a> package allows us to write codemods for JavaScript. To get started, we can use the following boilerplate code:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #79C0FF">module</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">exports</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">file</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">api</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">j</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> api.jscodeshift;</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">root</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">j</span><span style="color: #C9D1D9">(file.source);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Step 1: Find all instances of the code to change</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">instances</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> root.</span><span style="color: #D2A8FF">find</span><span style="color: #C9D1D9">(â€¦);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Step 2: Apply a code transformation and replace the code</span></span>
<span class="line"><span style="color: #C9D1D9">  instances.</span><span style="color: #D2A8FF">forEach</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">instance</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">j</span><span style="color: #C9D1D9">(path).</span><span style="color: #D2A8FF">replaceWith</span><span style="color: #C9D1D9">(â€¦);</span></span>
<span class="line"><span style="color: #C9D1D9">  });</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> root.</span><span style="color: #D2A8FF">toSource</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>##Step 1: Find all instances of the code to change
To accomplish step 1, weâ€™ll use pattern matching with AST (abstract syntax tree). AST allows us to represent code as a tree where each syntactic pattern is represented as a node, perhaps as a subtree of other nodes or with its own children nodes. There is a handy website called <a href="https://astexplorer.net/" target="_blank">AST Explorer</a> that we can use to visualize code as an AST.</p>
<p>Letâ€™s see what the AST structure looks like for our example code snippet:</p>
<p><img src="/step1-ast.png" alt="AST part 1"></p>
<p>The overall expression is a <code>VariableDeclaration</code> that has a <code>kind</code> of <code>const</code>, since we declared the variable with <code>const</code>, and a single <code>VariableDeclarator</code> for everything after the <code>const</code> keyword.</p>
<p>This <code>VariableDeclarator</code> in turn has two children. The first is the <code>id</code> or how the variable is named, in this case itâ€™s an <code>Identifier</code> thatâ€™s named <code>address</code>. The second is the <code>init</code> or how the variable is initialized, in this case itâ€™s a <code>MemberExpression</code> for <code>this.props.mailingAddress</code>.</p>
<p>Breaking down the <code>MemberExpression</code> further, we can see that itâ€™s comprised of a second <code>MemberExpression</code> to capture <code>this.props</code> and an <code>Identifier</code> to capture <code>mailingAddress</code>. The inner <code>MemberExpression</code> containing <code>this.props</code> can be broken down even further into a <code>ThisExpression</code> for the <code>this</code> keyword and an <code>Identifier</code> property with the name <code>props</code>.</p>
<p>If this is hard to see, you can open the <a href="https://astexplorer.net/" target="_blank">AST Explorer</a> and hover over different parts of the input code, which will highlight the corresponding AST nodes on the right side.</p>
<p>We can use the <code>find</code> method from jscodeshift and pass in a pattern based on what we see in the AST explorer. Hereâ€™s what that looks like:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">instances</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> root.</span><span style="color: #D2A8FF">find</span><span style="color: #C9D1D9">(j.VariableDeclarator, {</span></span>
<span class="line"><span style="color: #C9D1D9">  id: {</span></span>
<span class="line"><span style="color: #C9D1D9">    type: </span><span style="color: #A5D6FF">'Identifier'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">  },</span></span>
<span class="line"><span style="color: #C9D1D9">  init: {</span></span>
<span class="line"><span style="color: #C9D1D9">    object: {</span></span>
<span class="line"><span style="color: #C9D1D9">      type: </span><span style="color: #A5D6FF">'MemberExpression'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">      object: {</span></span>
<span class="line"><span style="color: #C9D1D9">        type: </span><span style="color: #A5D6FF">'ThisExpression'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">      },</span></span>
<span class="line"><span style="color: #C9D1D9">      property: {</span></span>
<span class="line"><span style="color: #C9D1D9">        name: </span><span style="color: #A5D6FF">'props'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">      },</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">    property: {</span></span>
<span class="line"><span style="color: #C9D1D9">      type: </span><span style="color: #A5D6FF">'Identifier'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">  },</span></span>
<span class="line"><span style="color: #C9D1D9">});</span></span></code></pre>
<p>At this point, itâ€™s good to sanity check that our search works as expected. To do so, I like to test the codemod on one file. Letâ€™s say we have the following example component that does a bunch of things, including displaying an address from the props:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">class</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ExampleComponent</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extends</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">React</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">Component</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// other interesting behavior</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">render</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">address</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.props.mailingAddress;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">      &#x3C;></span></span>
<span class="line"><span style="color: #C9D1D9">        // other components</span></span>
<span class="line"><span style="color: #C9D1D9">        &#x3C;</span><span style="color: #7EE787">AddressDisplay</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">address</span><span style="color: #FF7B72">={</span><span style="color: #C9D1D9">address</span><span style="color: #FF7B72">}</span><span style="color: #C9D1D9"> /></span></span>
<span class="line"><span style="color: #C9D1D9">        // other components</span></span>
<span class="line"><span style="color: #C9D1D9">      &#x3C;/></span></span>
<span class="line"><span style="color: #C9D1D9">    );</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>We can run our codemod and add some <code>console.log</code> statements to ensure that itâ€™s finding the correct lines.</p>
<p>To run the codemod, youâ€™ll need the jscodeshift CLI:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">jscodeshift -t ~/path/to/codemod.js ~/path/to/component.jsx</span></span></code></pre>
<p>-t specifies to transform the code.</p>
<p>Adding logging:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(instances.</span><span style="color: #79C0FF">length</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">// outputs 1</span></span></code></pre>
<p>Not convinced? We can dig into the instance and log some of the properties, for example the name:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(instances[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">].</span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'id'</span><span style="color: #C9D1D9">).node.name); </span><span style="color: #8B949E">// outputs address</span></span></code></pre>
<p>Great! Looks like itâ€™s finding what weâ€™re expecting. Letâ€™s move on to step 2.</p>
<p>##Step 2: Apply a transformation and replace the code
To figure out how to represent our target code, weâ€™ll go back to the AST explorer. This time, our input will be our desired code.</p>
<p><img src="/step2-ast.png" alt="AST part 2"></p>
<p>Again, our main output is a <code>VariableDeclaration</code> of <code>const</code> kind with a <code>VariableDeclarator</code>, but the <code>VariableDeclarator</code> subtree is different. For the <code>id</code>, instead of the name of the variable, we have an <code>ObjectPattern</code> to represent a JavaScript Object. The properties of the object are an array for each key/value pair. For our example, there is a single <code>Property</code> with a key of <code>address</code> and a value of <code>mailingAddress</code>.</p>
<p>For the <code>init</code>, we have a <code>MemberExpression</code> that matches the inner <code>MemberExpression</code> from the first step, which makes sense because the expression to the right of the equals sign in our target code is simply <code>this.props</code>.</p>
<p>Now letâ€™s translate this into our replace method. We can learn what the inputs are for each type by looking at the type definitions in the <a href="https://github.com/benjamn/ast-types/blob/master/def" target="_blank">ast-types library</a>. The fields for each type correspond to its arguments.</p>
<p>Our <code>ObjectPattern</code> has one <code>Property</code> for the one key/valule pair. We can pull the names from the instance:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">variableName</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> instance.</span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'id'</span><span style="color: #C9D1D9">).node.name;</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">propName</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> instance.</span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'init'</span><span style="color: #C9D1D9">).node.property.name;</span></span></code></pre>
<p>Then we can use these as inputs into our <code>ObjectPattern</code>:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">j.</span><span style="color: #D2A8FF">objectPattern</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">  [</span></span>
<span class="line"><span style="color: #C9D1D9">    j.</span><span style="color: #D2A8FF">property</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'init'</span><span style="color: #C9D1D9">, j.</span><span style="color: #D2A8FF">identifier</span><span style="color: #C9D1D9">(propName), j.</span><span style="color: #D2A8FF">identifier</span><span style="color: #C9D1D9">(variableName)),</span></span>
<span class="line"><span style="color: #C9D1D9">  ],</span></span>
<span class="line"><span style="color: #C9D1D9">),</span></span></code></pre>
<p>Next weâ€™ll build the <code>MemberExpression</code> by looking at the type and seeing what the inputs are.</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">j.</span><span style="color: #D2A8FF">memberExpression</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">  j.</span><span style="color: #D2A8FF">thisExpression</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">  j.</span><span style="color: #D2A8FF">identifier</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'props'</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">)</span></span></code></pre>
<p>Combining these, we get our replace step:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">instances.</span><span style="color: #D2A8FF">forEach</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">instance</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">variableName</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> instance.</span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'id'</span><span style="color: #C9D1D9">).node.name;</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">propName</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> instance.</span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'init'</span><span style="color: #C9D1D9">).node.property.name;</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">j</span><span style="color: #C9D1D9">(instance).</span><span style="color: #D2A8FF">replaceWith</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">    j.</span><span style="color: #D2A8FF">variableDeclarator</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">      j.</span><span style="color: #D2A8FF">objectPattern</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        [</span></span>
<span class="line"><span style="color: #C9D1D9">          j.</span><span style="color: #D2A8FF">property</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'init'</span><span style="color: #C9D1D9">, j.</span><span style="color: #D2A8FF">identifier</span><span style="color: #C9D1D9">(propName), j.</span><span style="color: #D2A8FF">identifier</span><span style="color: #C9D1D9">(variableName)),</span></span>
<span class="line"><span style="color: #C9D1D9">        ],</span></span>
<span class="line"><span style="color: #C9D1D9">      ),</span></span>
<span class="line"><span style="color: #C9D1D9">      j.</span><span style="color: #D2A8FF">memberExpression</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        j.</span><span style="color: #D2A8FF">thisExpression</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">        j.</span><span style="color: #D2A8FF">identifier</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'props'</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">      ),</span></span>
<span class="line"><span style="color: #C9D1D9">    ),</span></span>
<span class="line"><span style="color: #C9D1D9">  );</span></span>
<span class="line"><span style="color: #C9D1D9">});</span></span></code></pre>
<p>Letâ€™s run our codemod on our test component again and see what happens:</p>
<p>Output:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">class</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ExampleComponent</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extends</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">React</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">Component</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// other interesting behavior</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">render</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FFA657">address</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">mailingAddress</span></span>
<span class="line"><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.props;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">      &#x3C;></span></span>
<span class="line"><span style="color: #C9D1D9">        // other components</span></span>
<span class="line"><span style="color: #C9D1D9">        &#x3C;</span><span style="color: #7EE787">AddressDisplay</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">address</span><span style="color: #FF7B72">={</span><span style="color: #C9D1D9">address</span><span style="color: #FF7B72">}</span><span style="color: #C9D1D9"> /></span></span>
<span class="line"><span style="color: #C9D1D9">        // other components</span></span>
<span class="line"><span style="color: #C9D1D9">      &#x3C;/></span></span>
<span class="line"><span style="color: #C9D1D9">    );</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>Itâ€™s <em>almost</em> what we expect, but there are line breaks inside the object. Upon digging into the <a href="https://github.com/benjamn/recast/blob/52a7ec3eaaa37e78436841ed8afc948033a86252/lib/printer.js#L575" target="_blank">recast library</a> that jscodeshift uses to print, it looks like line breaks are built in to how <code>ObjectPattern</code> is printed.</p>
<p>Additionally, if we have a case where the variable name and prop name are the same, ESLint will complain further that we can use the object shorthand syntax:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #FFA657">address</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">address</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9"> props; </span><span style="color: #8B949E">// Angry ESLint</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">address</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.props; </span><span style="color: #8B949E">// Happy ESLint</span></span></code></pre>
<p>Fortunately, both of these issues can be fixed with ESLintâ€™s fix option. The shorthand error can also be addressed by extending our codemod â€” the <code>ObjectPattern</code> type accepts a shorthand parameter that applies if the variable name and prop name are the same. However, since weâ€™ll be using the ESLint auto-fix feature anyway, Iâ€™d prefer to just let ESLint fix it for us.</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">eslint --fix ~/path/to/component.jsx</span></span></code></pre>
<p>There you go! Itâ€™s definitely a process that involves a lot of trial and error, console logging, and back and forth between the code and the AST explorer, but it can end up being more efficient and saving more time than manually applying a transformation.</p>
<p>##Debugging tips</p>
<ul>
<li><code>console.log</code> is your friend! I havenâ€™t found a way to get a debugger (if you know a way, please let me know!), so Iâ€™ve been relying heavily on logging at every step to verify the behavior. Logging <code>Object.keys</code> and <code>Object.entries</code> has been especially useful in seeing all the available properties.</li>
<li>Use the AST explorer! Writing codemods would be almost impossible without some way of visualizing code as an AST.</li>
<li>When youâ€™re at the replace step, ensure that youâ€™re passing in the correct arguments to the node types that youâ€™re building. You can look at the type definitions in the <code>ast-types</code> repo for all the type annotations.</li>
<li>Make sure you are using the correct parser setting. We use Flow in our JavaScript so I include <code>parser=flow</code> in all my <code>jscodeshift</code> commands.</li>
<li>Look at existing codemods, there are some great examples in the <a href="https://github.com/reactjs/react-codemod" target="_blank">react-codemod</a> library. If youâ€™re looking to apply a transformation, check online to see if someone has already written something similar.</li>
</ul>
<h1 id="reference">Reference</h1>
<p>All of the links from inside the article:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank">ASTs (Abstract Syntax Trees)</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment" target="_blank">ES6 destructuring syntax</a></li>
<li><a href="https://github.com/facebook/jscodeshift" target="_blank">jscodeshift</a></li>
<li><a href="https://astexplorer.net/" target="_blank">AST Explorer</a></li>
<li><a href="https://github.com/benjamn/ast-types/tree/master/def" target="_blank">AST type definitions</a></li>
<li><a href="https://github.com/reactjs/react-codemod" target="_blank">react-codemod</a></li>
</ul>
<p>Lastly, hereâ€™s the codemod in its entirety:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #79C0FF">module</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">exports</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">file</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">api</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">j</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> api.jscodeshift;</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">root</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">j</span><span style="color: #C9D1D9">(file.source);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Step 1: Find all instances of the code to change</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">instances</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> root.</span><span style="color: #D2A8FF">find</span><span style="color: #C9D1D9">(j.VariableDeclarator, {</span></span>
<span class="line"><span style="color: #C9D1D9">    id: {</span></span>
<span class="line"><span style="color: #C9D1D9">      type: </span><span style="color: #A5D6FF">'Identifier'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">    init: {</span></span>
<span class="line"><span style="color: #C9D1D9">      object: {</span></span>
<span class="line"><span style="color: #C9D1D9">        type: </span><span style="color: #A5D6FF">'MemberExpression'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        object: {</span></span>
<span class="line"><span style="color: #C9D1D9">          type: </span><span style="color: #A5D6FF">'ThisExpression'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">        property: {</span></span>
<span class="line"><span style="color: #C9D1D9">          name: </span><span style="color: #A5D6FF">'props'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">      },</span></span>
<span class="line"><span style="color: #C9D1D9">      property: {</span></span>
<span class="line"><span style="color: #C9D1D9">        type: </span><span style="color: #A5D6FF">'Identifier'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">      },</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Step 2: Apply a code transformation and replace the code</span></span>
<span class="line"><span style="color: #C9D1D9">  instances.</span><span style="color: #D2A8FF">forEach</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">instance</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">variableName</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> instance.</span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'id'</span><span style="color: #C9D1D9">).node.name;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">propName</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> instance.</span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'init'</span><span style="color: #C9D1D9">).node.property.name;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">j</span><span style="color: #C9D1D9">(instance).</span><span style="color: #D2A8FF">replaceWith</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">      j.</span><span style="color: #D2A8FF">variableDeclarator</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        j.</span><span style="color: #D2A8FF">objectPattern</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">          [</span></span>
<span class="line"><span style="color: #C9D1D9">            j.</span><span style="color: #D2A8FF">property</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'init'</span><span style="color: #C9D1D9">, j.</span><span style="color: #D2A8FF">identifier</span><span style="color: #C9D1D9">(propName), j.</span><span style="color: #D2A8FF">identifier</span><span style="color: #C9D1D9">(variableName)),</span></span>
<span class="line"><span style="color: #C9D1D9">          ],</span></span>
<span class="line"><span style="color: #C9D1D9">        ),</span></span>
<span class="line"><span style="color: #C9D1D9">        j.</span><span style="color: #D2A8FF">memberExpression</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">          j.</span><span style="color: #D2A8FF">thisExpression</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">          j.</span><span style="color: #D2A8FF">identifier</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'props'</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">        ),</span></span>
<span class="line"><span style="color: #C9D1D9">      ),</span></span>
<span class="line"><span style="color: #C9D1D9">    );</span></span>
<span class="line"><span style="color: #C9D1D9">  });</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> root.</span><span style="color: #D2A8FF">toSource</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
    </article>
  </main>
          </main>
        </div>
        <footer class="footer footer-center block mb-5 pt-10">
  <div class="inline opacity-75">
    Built by Raymond Luong with Astro and the <a href="https://astro-modern-personal-website.netlify.app/" target="_blank">Astro Modern Personal Website Template</a> ðŸš€
  </div>
</footer>
      </div>
      <nav class="drawer-side bg-base-200">
  <label for="my-drawer" class="drawer-overlay bg-base-200"></label>
  <div class="menu flex flex-col flex-nowrap p-4 overflow-y-auto w-[21rem] bg-base-200 text-base-content">
    <a href="/">
      <div class="avatar w-1/2 block m-auto mt-3 mb-6">
        <img class="mask mask-circle" src="/profile.jpg" alt="Profile image of Raymond">
      </div>
    </a>
    <ul class="grow shrink">
      <li><a href="/">Home</a></li>
      <li><a href="/about">About</a></li>
      <li><a href="/blog/">Blog</a></li>
    </ul>
    <div class="social-icons px-4 my-2 flex self-center">
      <a href="https://www.linkedin.com/in/raymondluong" class="mx-2 hover:scale-125 transition" aria-label="LinkedIn" target="_blank">
            <svg viewBox="0 0 24 24" class="w-6 h-6" astro-icon="mdi:linkedin"><path fill="currentColor" d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg>
          </a><a href="https://www.github.com/raymondluong" class="mx-2 hover:scale-125 transition" aria-label="Github" target="_blank">
            <svg viewBox="0 0 24 24" class="w-6 h-6" astro-icon="mdi:github"><path fill="currentColor" d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg>
          </a><a href="https://www.twitter.com/luongraymond" class="mx-2 hover:scale-125 transition" aria-label="Twitter" target="_blank">
            <svg viewBox="0 0 24 24" class="w-6 h-6" astro-icon="mdi:twitter"><path fill="currentColor" d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/></svg>
          </a>
    </div>
  </div>
</nav>
    </div>
  </body></html>