{"data":{"site":{"siteMetadata":{"title":"Blog by Raymond Luong","subtitle":"Software Engineer in San Francisco","author":{"name":"Raymond Luong","twitter":"luongraymond"},"disqusShortname":"","url":"https://www.raymondluong.com/"}},"markdownRemark":{"id":"4325f427-fdd1-55fe-99a5-08a692e3743e","html":"<p>One of the most exciting parts about working with JavaScript and front-end development is the fast-paced nature of the industry. New patterns and standards evolve over time. However, keeping up with the changes can be complex and time-consuming because they may involve large-scale changes or refactors that are a bit more involved than a simple find-and-replace. </p>\n<p>Fortunately, codemods are a handy tool that help us automate these refactors. In this article, I’ll share more about codemods, walk through a simple codemod that I wrote, and share some tips for debugging.</p>\n<h1>What are codemods?</h1>\n<p>Codemods are scripts that automate a code change. They’re usually comprised of two parts:</p>\n<ol>\n<li>The first part is to find all instances of code to be changed, most easily accomplished with some form of pattern matching.</li>\n<li>The second part is to apply a transformation to each instance, usually based on the original instance but with some modifications. </li>\n</ol>\n<h1>When can I use codemods?</h1>\n<p>I mentioned large-scale refactors earlier — these can happen when upgrading versions of packages where existing methods are deprecated or new methods are introduced. They can also be used for syntax improvements or linting fixes. For example, in my current role at Gusto, we’ve used codemods to fix ESLint errors and move off deprecated React features.</p>\n<h1>How do I write one?</h1>\n<p>To demonstrate how to write a codemod, I’ll walk through an example I wrote to fix an ESLint error. I assume a basic understanding of JavaScript and React and tree data structures (wording). I’ll also talk about ASTs (Abstract Syntax Trees) but prior knowledge is not a prerequisite. </p>\n<h2>Context</h2>\n<p>At Gusto, we added ESLint to our codebase after we had already written a bunch of React components. Some of our existing components did not match the ESLint rules that we decided to enforce, but rather than having those errors block us from adding ESLint, we decided to suppress the existing errors and add ESLint so it could immediately start having value for our new code going forward. One of the errors we suppressed is <code class=\"language-text\">react/destructuring-assignment</code>. This ESLint rule prefers using JavaScript ES6 destructuring syntax when possible. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> mailingAddress<span class=\"token punctuation\">:</span> address <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">;</span></code></pre></div>\n<p>is preferred to</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> address <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>mailingAddress<span class=\"token punctuation\">;</span></code></pre></div>\n<p>There are a bunch of components in our codebase that do not destructure and have the destructuring-assignment rule suppressed. I’ll walk through a codemod I wrote to address the specific case above. Note that the example above doesn’t cover <em>all</em> the violations of the destructuring-assignment rule. When writing codemods, I’ve found that it’s simplest to start with the basic cases and gradually add on more complex cases.</p>\n<h2>Step 0: Boilerplate code</h2>\n<p>The <a href=\"https://github.com/facebook/jscodeshift\" target=\"_blank\">jscodeshift</a> package allows us to write codemods for JavaScript. To get started, we can use the following boilerplate code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">file<span class=\"token punctuation\">,</span> api</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> j <span class=\"token operator\">=</span> api<span class=\"token punctuation\">.</span>jscodeshift<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span> <span class=\"token function\">j</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Step 1: Find all instances of the code to change</span>\n  <span class=\"token keyword\">const</span> instances <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>…<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Step 2: Apply a code transformation and replace the code</span>\n  instances<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instance</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">j</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replaceWith</span><span class=\"token punctuation\">(</span>…<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> root<span class=\"token punctuation\">.</span><span class=\"token function\">toSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Step 1: Find all instances of the code to change</h2>\n<p>To accomplish this, we’ll use pattern matching with AST (abstract syntax tree). The main idea is that code can be represented as a tree where each syntactic pattern is represented as a node, perhaps as a subtree of other nodes or with its own children nodes. There is a handy website called <a href=\"https://astexplorer.net/\" target=\"_blank\">AST Explorer</a> that we can use to visualize code as an AST. Let’s see what the AST structure looks like for our example code snippet:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> address <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>mailingAddress<span class=\"token punctuation\">;</span></code></pre></div>\n<p>&#x3C; TODO: screenshot ></p>\n<p>The overall expression is a <code class=\"language-text\">VariableDeclaration</code> that has a kind of <code class=\"language-text\">const</code> since we declared the variable with <code class=\"language-text\">const</code>, and a single <code class=\"language-text\">VariableDeclarator</code> for everything after the <code class=\"language-text\">const</code> keyword. This <code class=\"language-text\">VariableDeclarator</code> in turn has two children: the <code class=\"language-text\">id</code> which is an Identifier for the name of the variable, in this case address, and the <code class=\"language-text\">init</code> or how the variable is initialized, in this case it’s a <code class=\"language-text\">MemberExpression</code> that has its own subtree.</p>\n<p>&#x3C; TODO: screenshot ></p>\n<p>Breaking down the <code class=\"language-text\">MemberExpression</code> further, we can see that it’s comprised of another <code class=\"language-text\">MemberExpression</code> to capture <code class=\"language-text\">this.props</code> and a <code class=\"language-text\">Property</code> to capture <code class=\"language-text\">mailingAddress</code>. The child <code class=\"language-text\">MemberExpression</code> containing <code class=\"language-text\">this.props</code> can be broken down even further into a <code class=\"language-text\">ThisExpression</code> for the <code class=\"language-text\">this</code> keyword and a <code class=\"language-text\">Property</code> with the name <code class=\"language-text\">props</code>. </p>\n<p>We can use the <code class=\"language-text\">find</code> method from jscodeshift and pass in a pattern based on what we see in the AST explorer. Here’s what that looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> instances <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>j<span class=\"token punctuation\">.</span>VariableDeclarator<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  init<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    object<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token punctuation\">:</span> <span class=\"token string\">'MemberExpression'</span><span class=\"token punctuation\">,</span>\n      object<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        type<span class=\"token punctuation\">:</span> <span class=\"token string\">'ThisExpression'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      property<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        name<span class=\"token punctuation\">:</span> <span class=\"token string\">'props'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    property<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token punctuation\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>At this point, it’s good to sanity check that our search works as expected. To do so, I like to test the codemod on one file. Let’s say we have the following example component that does a bunch of things, including render the address from the props:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ExampleComponent</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// other interesting behavior</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> address <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>mailingAddress<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n        <span class=\"token comment\">// render other components</span>\n        <span class=\"token operator\">&lt;</span>AddressDisplay address<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>address<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We can run our codemod and add some <code class=\"language-text\">console.log</code> statements to ensure that it’s finding the correct lines.</p>\n<p>To run the codemod, you’ll need the jscodeshift CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">jscodeshift -t ~/path/to/codemod.js ~/path/to/component.jsx</code></pre></div>\n<p>-t specifies to transform the code.</p>\n<p>Adding logging:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>instances<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token comment\">// outputs 1</span></code></pre></div>\n<p>Not convinced? We can dig into each declaration and log some of the properties</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>declarations<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span> <span class=\"token comment\">// outputs address, TODO: double check this</span></code></pre></div>\n<p>Great! Looks like it’s finding what we’re expecting. Let’s move on to step 2.</p>\n<h2>Step 2: Apply a transformation and replace the code</h2>\n<p>To figure out how to represent our target code, we’ll go back to the AST explorer. This time, our input will be our desired code.</p>\n<p>Screenshot of input and output</p>\n<p>&#x3C; TODO: screenshot ></p>\n<p>Again, our main output is a <code class=\"language-text\">VariableDeclaration</code> of <code class=\"language-text\">const</code> kind with a VariableDeclarator, but the <code class=\"language-text\">VariableDeclarator</code> subtree is different. As the <code class=\"language-text\">id</code>, instead of the name of the variable, we have an <code class=\"language-text\">ObjectPattern</code> to represent a JavaScript Object. Inside this object, there is a single <code class=\"language-text\">Property</code> with a key of <code class=\"language-text\">address</code> and a value of <code class=\"language-text\">mailingAddress</code>. As the <code class=\"language-text\">init</code>, we have a <code class=\"language-text\">MemberExpression</code> that matches the second <code class=\"language-text\">MemberExpression</code> from before, which makes sense because the expression to the right of the equals sign in our target code is simply <code class=\"language-text\">this.props</code>. </p>\n<p>We can learn what the inputs are for each type by looking at the type definitions in the <a href=\"https://github.com/benjamn/ast-types/blob/master/def/es6.ts\" target=\"_blank\">ast-types library</a>. The fields for each type correspond to its arguments.</p>\n<p>Our <code class=\"language-text\">ObjectPattern</code> has one <code class=\"language-text\">Property</code> for the one key/valule pair. We can pull the names from the instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> variableName <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> propName <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'init'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>property<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Then we can use these as inputs into our <code class=\"language-text\">ObjectPattern</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">j<span class=\"token punctuation\">.</span><span class=\"token function\">objectPattern</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">[</span>\n    j<span class=\"token punctuation\">.</span><span class=\"token function\">property</span><span class=\"token punctuation\">(</span><span class=\"token string\">'init'</span><span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">.</span><span class=\"token function\">identifier</span><span class=\"token punctuation\">(</span>propName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">.</span><span class=\"token function\">identifier</span><span class=\"token punctuation\">(</span>variableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Next we’ll build the <code class=\"language-text\">MemberExpression</code> by looking at the type and seeing what the inputs are. </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">j<span class=\"token punctuation\">.</span><span class=\"token function\">memberExpression</span><span class=\"token punctuation\">(</span>\n  j<span class=\"token punctuation\">.</span><span class=\"token function\">thisExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  j<span class=\"token punctuation\">.</span><span class=\"token function\">identifier</span><span class=\"token punctuation\">(</span><span class=\"token string\">'props'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Combining these, we get our replace step:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">instances<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instance</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> variableName <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> propName <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'init'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>property<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">j</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replaceWith</span><span class=\"token punctuation\">(</span>\n    j<span class=\"token punctuation\">.</span><span class=\"token function\">variableDeclarator</span><span class=\"token punctuation\">(</span>\n      j<span class=\"token punctuation\">.</span><span class=\"token function\">objectPattern</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>\n          j<span class=\"token punctuation\">.</span><span class=\"token function\">property</span><span class=\"token punctuation\">(</span><span class=\"token string\">'init'</span><span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">.</span><span class=\"token function\">identifier</span><span class=\"token punctuation\">(</span>propName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">.</span><span class=\"token function\">identifier</span><span class=\"token punctuation\">(</span>variableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      j<span class=\"token punctuation\">.</span><span class=\"token function\">memberExpression</span><span class=\"token punctuation\">(</span>\n        j<span class=\"token punctuation\">.</span><span class=\"token function\">thisExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        j<span class=\"token punctuation\">.</span><span class=\"token function\">identifier</span><span class=\"token punctuation\">(</span><span class=\"token string\">'props'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Let’s run our codemod on our test component again and see what happens:</p>\n<p>Output:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ExampleComponent</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// other interesting behavior</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n      address<span class=\"token punctuation\">:</span> mailingAddress\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n        <span class=\"token comment\">// render other components</span>\n        <span class=\"token operator\">&lt;</span>AddressDisplay address<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>address<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It’s <em>almost</em> what we expect, but there are line breaks inside the object. Upon digging into the recast library that js-codeshift uses to print, it looks like line breaks are built in to how <code class=\"language-text\">ObjectPattern</code> is printed. </p>\n<p>Additionally, if we have a case where the variable name and prop name are the same, ESLint will complain further that we can use the object shorthand syntax:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> address<span class=\"token punctuation\">:</span> address <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span> props<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Angry ESLint</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> address <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Happy ESLint</span></code></pre></div>\n<p>Fortunately, both of these issues can be fixed with ESLint’s auto-fix feature. The shorthand error can also be addressed by extending our codemod — the <code class=\"language-text\">ObjectPattern</code> type accepts a shorthand parameter that applies if the variable name and prop name are the same. However, since we’ll be using the ESLint auto-fix feature anyway, I’d prefer to just let ESLint fix it for us.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">eslint --fix ~/path/to/component.jsx</code></pre></div>\n<p>There you go! It’s definitely a process that involves a lot of trial and error, console logging, and back and forth between the codemod and the AST explorer, but it can end up being more efficient and saving more time than manually applying a transformation.</p>\n<p>Note: I’m aware that my codemod doesn’t group destructuring variables well, that is, variable declared on multiple lines from the same object will not be grouped into one. </p>\n<h2>Debugging tips</h2>\n<ul>\n<li><code class=\"language-text\">console.log</code> is your friend! I haven’t found a way to get a debugger (if you know a way, please let me know!), so I’ve been relying heavily on logging at every step to verify the behavior. Logging <code class=\"language-text\">Object.keys</code> and <code class=\"language-text\">Object.entries</code> has been especially useful in seeing all the available properties.</li>\n<li>Use the AST explorer! Writing codemods would be almost impossible without some way of visualizing code as an AST.</li>\n<li>When you’re at the replace step, ensure that you’re passing in the correct arguments to the node types that you’re building. You can look at the type definitions in the <code class=\"language-text\">ast-types</code> repo for all the type annotations.</li>\n<li>Make sure you are using the correct parser. We use Flow in our JavaScript so I include <code class=\"language-text\">parser=flow</code> in all my <code class=\"language-text\">jscodeshift</code> commands.</li>\n<li>Lastly, look at existing codemods, there are some great examples in the <code class=\"language-text\">react-codemod</code> library. If you’re looking to apply a transformation, check online to see if someone has already written something similar. </li>\n</ul>\n<h1>Reference</h1>\n<p>All of the links inside the article:</p>\n<ul>\n<li><a href=\"https://github.com/facebook/jscodeshift\" target=\"_blank\">jscodeshift</a></li>\n<li><a href=\"https://astexplorer.net/\" target=\"_blank\">AST Explorer</a></li>\n<li><a href=\"https://github.com/benjamn/ast-types/tree/master/def\" target=\"_blank\">AST type definitions</a></li>\n</ul>\n<p>And lastly, here’s the codemod in its entirety:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">file<span class=\"token punctuation\">,</span> api</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> j <span class=\"token operator\">=</span> api<span class=\"token punctuation\">.</span>jscodeshift<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span> <span class=\"token function\">j</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Step 1: Find all instances of the code to change</span>\n  <span class=\"token keyword\">const</span> instances <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>j<span class=\"token punctuation\">.</span>VariableDeclarator<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token punctuation\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    init<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      object<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        type<span class=\"token punctuation\">:</span> <span class=\"token string\">'MemberExpression'</span><span class=\"token punctuation\">,</span>\n        object<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          type<span class=\"token punctuation\">:</span> <span class=\"token string\">'ThisExpression'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        property<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          name<span class=\"token punctuation\">:</span> <span class=\"token string\">'props'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      property<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        type<span class=\"token punctuation\">:</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Step 2: Apply a code transformation and replace the code</span>\n  instances<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instance</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> variableName <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> propName <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'init'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>property<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">j</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replaceWith</span><span class=\"token punctuation\">(</span>\n      j<span class=\"token punctuation\">.</span><span class=\"token function\">variableDeclarator</span><span class=\"token punctuation\">(</span>\n        j<span class=\"token punctuation\">.</span><span class=\"token function\">objectPattern</span><span class=\"token punctuation\">(</span>\n          <span class=\"token punctuation\">[</span>\n            j<span class=\"token punctuation\">.</span><span class=\"token function\">property</span><span class=\"token punctuation\">(</span><span class=\"token string\">'init'</span><span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">.</span><span class=\"token function\">identifier</span><span class=\"token punctuation\">(</span>propName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">.</span><span class=\"token function\">identifier</span><span class=\"token punctuation\">(</span>variableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        j<span class=\"token punctuation\">.</span><span class=\"token function\">memberExpression</span><span class=\"token punctuation\">(</span>\n          j<span class=\"token punctuation\">.</span><span class=\"token function\">thisExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          j<span class=\"token punctuation\">.</span><span class=\"token function\">identifier</span><span class=\"token punctuation\">(</span><span class=\"token string\">'props'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","fields":{"tagSlugs":["/tags/java-script/","/tags/codemods/"]},"frontmatter":{"title":"Getting Started with Codemods in JavaScript","tags":["JavaScript","Codemods"],"date":"2019-07-05","description":"Codemods are a handy tool to automate large-scale refactors. In this article, I'll share more about codemods, walk through a simple codemod that I wrote, and share some tips for debugging."}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/getting-started-with-codemods-in-javascript/"}}